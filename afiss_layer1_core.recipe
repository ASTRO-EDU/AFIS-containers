BootStrap: docker
From: centos:7.3.1611

%labels
  author "andrea.bulgarelli@inaf.it, nicolo.parmiggiani@inaf.it, antonio.addis@inaf.it, simotrone@gmail.com"
  version "0.10"

%setup
 #commands are executed on the host system outside of the container after the base OS has been installed

 #copy here the file used to source environments
 mkdir -p ${SINGULARITY_ROOTFS}/opt/module

 #copy here temporary configuration files that must be moved during the post step
 mkdir -p ${SINGULARITY_ROOTFS}/opt/conf

 mkdir -p ${SINGULARITY_ROOTFS}/usr/local/src

%files
 #to copy files from your host system into the container
 #Each line is a pair of <source> and <destination>, where the source is a path on your host system, and the destination is a path in the container.
 #Files are copied before any %post or installation procedures
 #module/root_v5.34.24 /opt/module
 module/anaconda-3.6 /opt/module
 #module/heasoft-6.25 /opt/module
 #module/heasoft-6.17 /opt/module
 #artifacts/heasoft-6.25src.tar.gz /usr/local/src
 #artifacts/heasoft-6.25precompiled.tgz /opt
 #artifacts/heasoft-6.17.tar.gz /opt
 #artifacts/ds9-7.3.2.tgz /usr/local/src
 #artifacts/cmake-3.12.3.tar.gz /usr/local/src
 #artifacts/cfitsio3450.tar.gz /usr/local/src
 #artifacts/gsl-1.15.tar.gz /usr/local/src
 #artifacts/root_v5.34.24.source.tar.gz /usr/local/src
 #artifacts/ImageMagick-6.7.8.9-18.el8.x86_64.rpm /usr/local/src

%post

  yum -y install epel-release-7-11 rsync-3.1.2 unzip-6.0 mailx-12.5 bzip2-1.0.6
#yum-utils arpwatch  mlocate pciutils bind-utils ntp emacs

  yum -y install git-1.8.3.1 make-3.82 gcc-4.8.5 gcc-c++-4.8.5 binutils-2.27 \
                 libX11-devel-1.6.7 libXpm-devel-3.5.12 libXft-devel-2.3.2 libXext-devel-1.3.3
  yum -y install curl-7.29.0 less-458 vim wget-1.14
  yum -y install libxcb-devel-1.13
  yum -y install man-pages-3.53 man-db-2.6.3 man

  #for HEASOFT
  yum -y install libXt-devel-1.1.5 perl-ExtUtils-MakeMaker-6.68 gcc-gfortran-4.8.5 ncurses-devel-5.9

  #yum -y install octave-3.8.2-20.el7
  #yum list available ImageMagick â€“showduplicates
  #yum localinstall /usr/local/src/ImageMagick-6.7.8.9-18.el8.x86_64.rpm
  yum -y install htop-2.2.0 ImageMagick-6.9.10.68
  #yum -y install ghostscript

  #yum -y install environment-modules
  #mkdir -p /opt/prod/modulefiles
  #echo "/opt/prod/modulefiles" >> /usr/share/Modules/init/.modulespath

  mkdir -p /opt/module

  #AGILE only
  yum -y install libXScrnSaver-1.2.2 libXp-1.0.2 libcurl-devel-7.29.0 iniparser-devel-3.1 libxml2-devel-2.9.1 openssl-devel-1.0.2k ruby-2.0.0.648 ruby-devel-2.0.0.648 rubygems-2.0.14.1
  yum install -y xorg-x11-server-Xvfb-1.20.4

  #scientific libraries
  yum -y install opencv-devel-2.4.5 fftw-devel-3.3.3 graphviz-devel-2.30.1

  # Optional packages:
  # yum install gcc-gfortran openssl-devel pcre-devel mesa-libGL-devel mesa-libGLU-devel glew-devel \
  #             ftgl-devel mysql-devel fftw-devel cfitsio-devel graphviz-devel \
  #             avahi-compat-libdns_sd-devel libldap-dev libxml2-devel gsl-static



  SRC_DIR="/usr/local/src"
  test -d $SRC_DIR || mkdir -p $SRC_DIR

  INSTALL_PREFIX=/usr/local
  export MAKEFLAGS=-j64

  echo "cmake 3.12.3"
  cd $SRC_DIR
  wget https://cmake.org/files/v3.12/cmake-3.12.3.tar.gz
  tar xzf cmake-3.12.3.tar.gz
  cd cmake-3.12.3
  ./bootstrap
  make install $MAKEFLAGS

  # echo "CFitsio"
  # cd $SRC_DIR
  # #wget http://heasarc.gsfc.nasa.gov/FTP/software/fitsio/c/cfitsio3450.tar.gz
  # tar xzf cfitsio3450.tar.gz
  # cd cfitsio
  # ./configure --prefix=$INSTALL_PREFIX
  # make
  # make shared
  # make install $MAKEFLAGS

  # echo "GSL"
  # cd $SRC_DIR
  # #wget http://mirror2.mirror.garr.it/mirrors/gnuftp/gsl/gsl-1.15.tar.gz
  # tar xvzf gsl-1.15.tar.gz
  # cd gsl-1.15
  # ./configure
  # make $MAKEFLAGS
  # make install
  # export GSL=$INSTALL_PREFIX

  echo "Install anaconda 5.3.0 x86_64"
  cd $SRC_DIR
  wget -q https://repo.anaconda.com/archive/Anaconda3-5.3.0-Linux-x86_64.sh
  echo "cfbf5fe70dd1b797ec677e63c61f8efc92dad930fd1c94d60390bb07fdc09959  Anaconda3-5.3.0-Linux-x86_64.sh" > anaconda_hash_sha256
  sha256sum -c anaconda_hash_sha256
  bash Anaconda3-5.3.0-Linux-x86_64.sh -b -p /opt/anaconda3
  ln -s /opt/anaconda3/etc/profile.d/conda.sh /etc/profile.d/conda.sh
  export PATH=/opt/anaconda3/bin:${PATH}

  # conda create -y -n pipe_manager_py36 python=3.6 astropy=3.0 lxml=4.1.1 mysql-connector-python=2.0.4
  # #conda clean -y --all

  # conda create -y -n py_mcal_27 python=2.7.5 scipy=0.18.1 numpy=1.12 matplotlib=2.0.2 basemap=1.0.7 lxml=3.2.1 mysql-connector-python=2.0.4 astropy=2.0.3
  # #conda clean -y --all

  # conda create -y -n py_alert_pipe_27 python=2.7.5 numpy=1.12 matplotlib=2.0.2 astropy=2.0.3 scipy=0.18.1 pytest=3.8.0 mysql-connector-python=2.0.4

  # conda clean -y --all

  ################ PART 2
  PATH="/opt/anaconda3/bin:${PATH}"
  export PATH

  # #for ALERT-PIPE
  # source /etc/profile.d/conda.sh
  # conda activate py_alert_pipe_27
  # pip install pyastronomy==0.12.0
  # pip install healpy==1.11.0
  # source deactivate

  # # Enabling python environment...
  # source /etc/profile.d/conda.sh
  # #for MCAL
  # conda activate py_mcal_27
  # pip install pyastronomy==0.12.0
  # pip install pyrr==0.9.2

  INSTALL_PREFIX=/usr/local
  export MAKEFLAGS=-j64

  # echo "DS9"
  # cd $SRC_DIR
  # tar xvzf ds9-7.3.2.tgz
  # mv ds9/ds9 /usr/local/bin

  # #wget http://ds9.si.edu/download/centos7/ds9.centos7.7.6.tar.gz
  # #tar xvzf ds9.centos7.7.6.tar.gz
  # #mv ds9 /usr/local/bin

  # echo "CERN root 5"
  # cd $SRC_DIR
  # #wget https://root.cern.ch/download/root_v5.34.24.source.tar.gz
  # tar xzf root_v5.34.24.source.tar.gz
  # cd root/
  # mkdir $SRC_DIR/build_root
  # cd $SRC_DIR/build_root
  # cmake -DCMAKE_INSTALL_PREFIX=$INSTALL_PREFIX $SRC_DIR/root
  # cmake --build . --target install

  # echo "IDL"


  #echo "CERN root 6"
  #cd $SRC_DIR
  #wget https://root.cern.ch/download/root_v6.14.04.source.tar.gz
  #tar xzf root_v6.14.04.source.tar.gz
  #cd root-6.14.04/
  #mkdir $SRC_DIR/build_root
  #cd $SRC_DIR/build_root
  #cmake $SRC_DIR/root-6.14.04
  #cmake --build . --target install

  #HEASOFT FULL PROCEDURE
  #cd $SRC_DIR
  #tar xvzf heasoft-6.25src.tar.gz
  #cd heasoft-6.25/BUILD_DIR/
  #./configure --prefix=/opt/heasoft-6.25
  #make
  #make install
  #remove to reduce size (not mandatory)
  #cd /opt/heasoft-6.25
  #rm -rf ftools/x86_64-pc-linux-gnu-libc2.17/refdata/
  #rm -rf Xspec/ demo/ hitomi/ integral/ maxi/ nicer/ nustar/ suzaku/ swift/
  #rm -rf spectral/
  #cd $SRC_DIR

  #HEASOFT FROM PRECOMPILED
  #cd /opt
  #tar xvzf heasoft-6.25precompiled.tgz
  #rm heasoft-6.25precompiled.tgz

  #tar xvzf heasoft-6.17.tar.gz
  #rm heasoft-6.17.tar.gz


  #remove files
  rm -rf $SRC_DIR

%environment

  PATH="/opt/anaconda3/bin:${PATH}"
  export PATH
  # Enabling python environment...
  #source /etc/profile.d/conda.sh
  #conda activate pipe_manager_py36

%help
