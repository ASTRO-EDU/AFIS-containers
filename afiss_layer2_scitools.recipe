BootStrap: localimage
From: afiss_layer1bis_idl.simg

%labels
  author "andrea.bulgarelli@inaf.it"
  version "1.0"

%setup

  SRC_DIR=/usr/local/src/
  #cp -rf AGILE-MCAL ${SINGULARITY_ROOTFS}/${SRC_DIR}
  mkdir -p ${SINGULARITY_ROOTFS}/$SRC_DIR
  #cp -rf tmp_download/AGILE-MCAL ${SINGULARITY_ROOTFS}/${SRC_DIR}
  #cp -rf tmp_download/AGILE-GRID-CAT2-Setup ${SINGULARITY_ROOTFS}/${SRC_DIR}

  mkdir -p ${SINGULARITY_ROOTFS}/data01
  #mkdir -p ${SINGULARITY_ROOTFS}/AGILE_PROC3
  mkdir -p ${SINGULARITY_ROOTFS}/ANALYSIS3
  #mkdir -p ${SINGULARITY_ROOTFS}/ASDC_PROC2
  #mkdir -p ${SINGULARITY_ROOTFS}/ASDC_PROC3


%files

  #SRC_DIR=/usr/local/src/
  #AGILE-MCAL ${SRC_DIR}
  #module/agile-B25-r5 /opt/module
  #module/agile-B24-r5 /opt/module
  #module/agile-B25-r5-cat2-B5 /opt/module
  #module/agile-mcal /opt/module

  #layer2_conf/DeepVar/website/deepsearch1/deepsearch1.php /opt/conf
  #layer2_conf/DeepVar/website/cat2/conf_cat2.php /opt/conf

  conf/empty.txt /data01/empty.txt
  #conf/empty.txt /AGILE_PROC3
  conf/empty.txt /ANALYSIS3
  #conf/empty.txt /ASDC_PROC2
  #conf/empty.txt /ASDC_PROC3

%post

  PATH="/opt/anaconda3/bin:${PATH}"
  export PATH
  # Enabling python environment...
  source /etc/profile.d/conda.sh
  #conda activate py_mcal_27

  SRC_DIR="/usr/local/src"
  test -d $SRC_DIR || mkdir -p $SRC_DIR
  INSTALL_PREFIX=/usr/local
  export MAKEFLAGS=-j64

  #echo "Install AGILE-GRID Science Tools B24"
  #cd $SRC_DIR
  #git clone https://github.com/AGILESCIENCE/AGILE-GRID-ScienceTools-Setup.git
  #export AGILE=/opt/prod/agile-B24-r5
  #export CFITSIO=$INSTALL_PREFIX
  #export ROOTSYS=$INSTALL_PREFIX
  #cd AGILE-GRID-ScienceTools-Setup/
  #git checkout BUILD24
  #./download.sh
  #./install.sh
  #rm -rf $AGILE/model
  #ln -s /opt/prod/agile-B25-r5/model/ $AGILE/
  #cd ..
  #rm -rf AGILE-GRID-ScienceTools-Setup


  # echo "Install AGILE-GRID Science Tools B25"
  # cd $SRC_DIR
  # git clone https://github.com/AGILESCIENCE/AGILE-GRID-ScienceTools-Setup.git
  # export AGILE=/opt/prod/agile-B25-r5
  # export AGILEPIPE=/opt/prod/AGILEPIPE

  # export CFITSIO=$INSTALL_PREFIX
  # export ROOTSYS=$INSTALL_PREFIX
  # export GSL=$INSTALL_PREFIX
  # export OPENCV=/usr/lib64
  # cd AGILE-GRID-ScienceTools-Setup/
  # git checkout BUILD25
  # ./downloadScienceTools.sh
  # ./installScienceTools.sh
  # ./downloadIRF.sh
  # ./installIRF.sh
  # rm -rf AGILE-GRID-ScienceTools-Setup

  # echo "Install AGILE-GRID CAT2 BUILD"
  # cd $SRC_DIR
  # #git clone https://github.com/AGILESCIENCE/AGILE-GRID-CAT2-Setup.git
  # export AGILE=/opt/prod/agile-B25-r5-cat2-B5
  # export AGILEPIPE=$AGILE/AGILEPIPE
  # export DEEPVAR=$AGILE/DeepVar
  # export CFITSIO=$INSTALL_PREFIX
  # export ROOTSYS=$INSTALL_PREFIX
  # export GSL=$INSTALL_PREFIX
  # export OPENCV=/usr/lib64
  # cd AGILE-GRID-CAT2-Setup
  # ./install.sh
  # rm -rf $AGILE/model
  # ln -s /opt/prod/agile-B25-r5/model/ $AGILE/
  # cd $DEEPVAR
  # rm -rf website
  # ./install.sh
  # cp /opt/conf/deepsearch1.php $DEEPVAR/website/deepsearch1
  # cp /opt/conf/conf_cat2.php $DEEPVAR/website/cat2/config.php

  #nel layer 6 vengono inseriti i link per i siti

  # echo "Install AGILE-MCAL Science Tools"
  # export MCALSW=/opt/prod/mcalsw
  # export ROOTSYS=$INSTALL_PREFIX
  # cd $SRC_DIR
  # cd AGILE-MCAL
  # export LD_LIBRARY_PATH=/usr/local/lib
  # git checkout pipeline
  # make install

  # rm -rf $SRC_DIR

%environment
  #export AGILE=/opt/prod/agile-B25-r5
  #PATH="$AGILE/bin:$AGILE/scripts:/usr/local/bin:/opt/anaconda3/bin:${PATH}"
  #export ROOTSYS=/usr/local
  #export LD_LIBRARY_PATH=$ROOTSYS/lib
  #export PATH
  # Enabling python environment...
  #source /etc/profile.d/conda.sh
  #conda activate py_mcal_27

  #export MODULELOAD="agile-B25-r5"
  #export EXECCOM="llsubmit"
  # export EXECCOM="sbatch"
  # export PATH_DATA="/AGILE_PROC3/"
  # export PATH_RES="/ANALYSIS3/"
  # export PATH_LOG="/ANALYSIS3/log/"
  # export ARCHIVE="ASDC2"
  # export AGILEPIPE="/opt/prod/AGILEPIPE/"
  # #spot6
  # export SPOT6CARDDIR="spot6"
  # export SPOT6QUEUE="large"
  # export SPOT6GEN_HTMLANDPNG=1


%help
  # agile needs opencv. opencv 2.4.5 in yum repo
  # https://docs.opencv.org/master/d7/d9f/tutorial_linux_install.html
