BootStrap: localimage
From: afiss_layer3_service.simg

%labels
  author "simotrone@gmail.com, andrea.bulgarelli@inaf.it"
  version "0.10"

%setup
 #commands are executed on the host system outside of the container after the base OS has been installed

 #copy here the file used to source environments

 #copy here temporary configuration files that must be moved during the post step
 SRC_DIR=/usr/local/src/
 mkdir -p ${SINGULARITY_ROOTFS}/$SRC_DIR
 #cp -rf artifacts/linphone-rpm ${SINGULARITY_ROOTFS}/${SRC_DIR}

 #mkdir -p ${SINGULARITY_ROOTFS}/etc/munin
 #mkdir -p ${SINGULARITY_ROOTFS}/var/www/html/munin

 #create dir for bind
 test -d ${SINGULARITY_ROOTFS}/data01 || mkdir -p ${SINGULARITY_ROOTFS}/data01
 #mkdir -p ${SINGULARITY_ROOTFS}/var/www/html/AGILEApp
 mkdir -p ${SINGULARITY_ROOTFS}/opt/start
 #test -d ${SINGULARITY_ROOTFS}/AGILE_PROC3 || mkdir -p ${SINGULARITY_ROOTFS}/AGILE_PROC3
 test -d ${SINGULARITY_ROOTFS}/ANALYSIS3   || mkdir -p ${SINGULARITY_ROOTFS}/ANALYSIS3
 #test -d ${SINGULARITY_ROOTFS}/ASDC_PROC2  || mkdir -p ${SINGULARITY_ROOTFS}/ASDC_PROC2
 #test -d ${SINGULARITY_ROOTFS}/ASDC_PROC3  || mkdir -p ${SINGULARITY_ROOTFS}/ASDC_PROC3
 mkdir -p ${SINGULARITY_ROOTFS}/var/www/html/analysis
 #mkdir -p ${SINGULARITY_ROOTFS}/var/www/html/agilemcal
 #mkdir -p ${SINGULARITY_ROOTFS}/var/www/html/agile-gui-sci
 mkdir -p ${SINGULARITY_ROOTFS}/var/www/html/analysis_grawita
 mkdir -p ${SINGULARITY_ROOTFS}/var/www/html/supergrawita-gui
 mkdir -p ${SINGULARITY_ROOTFS}/var/www/html/analysis_run
 #mkdir -p ${SINGULARITY_ROOTFS}/opt/prod/pipeline_manager
 #mkdir -p ${SINGULARITY_ROOTFS}/opt/prod/AGILE-MCAL-PIPE
 #mkdir -p ${SINGULARITY_ROOTFS}/opt/prod/DeepVar
 chown -R rt:apache ${SINGULARITY_ROOTFS}/var/lib/php/session


%files
 #to copy files from your host system into the container
 #Each line is a pair of <source> and <destination>, where the source is a path on your host system, and the destination is a path in the container.
 #Files are copied before any %post or installation procedures
 #layer5_conf/munin-htpasswd /etc/munin

 conf/empty.txt /data01/empty.txt
 conf/empty.txt /opt/start
 #conf/empty.txt /AGILE_PROC3
 conf/empty.txt /ANALYSIS3
 #conf/empty.txt /ASDC_PROC2
 #conf/empty.txt /ASDC_PROC3
 conf/empty.txt /var/www/html/analysis
 conf/empty.txt /var/www/html/analysis_grawita
 conf/empty.txt /var/www/html/analysis_run
 #conf/empty.txt /var/www/html/agilemcal
 #conf/empty.txt /var/www/html/agile-gui-sci
 conf/empty.txt /var/www/html/supergrawita-gui
 #conf/empty.txt /opt/prod/pipeline_manager
 #conf/empty.txt /opt/prod/AGILE-MCAL-PIPE
 #conf/empty.txt /opt/prod/DeepVar
 #conf/empty.txt /opt/prod/agilepipe.conf
 #conf/empty.txt /opt/prod/AGILEPIPE/schedule.txt
 #conf/empty.txt /var/www/html/AGILEApp
 layer3_conf/phpMyAdmin.conf /etc/httpd/conf.d/phpMyAdmin.conf
 layer3_conf/phpmyadmin.config.inc.php /etc/phpMyAdmin/config.inc.php
 conf/empty.txt /etc/slurm/slurm.conf
 conf/empty.txt /etc/slurm/slurmdbd.conf
 repos/AlertReceiver_GCNnetwork/ /opt/prod/GCNdaemon

 conf/credits /opt/conf
 #conf/logo1 /opt/conf
 conf/init_db_script /opt/conf
 #conf/agile4.textart /opt/conf

# artifacts/ligo/skymap/tool/ligo_skymap_plot.py /opt/conf/ligo_skymap_plot.py

 #tmp_download/AGILEPIPE-Web/AGILEApp/ /var/www/html
 

%post

  #ln -s /ANALYSIS3/app /var/www/html/AGILEApp/RT


  #SRC_DIR=/usr/local/src/
  #cd $SRC_DIR/linphone-rpm
  #yum install -y *.rpm

  yum install -y gedit-3.28.1

  #yum install -y xorg-x11-server-Xvfb
  #yum -y install munin munin-node
  #chown munin:munin /var/www/html/munin

  yum  install -y bc-1.06.95 lynx-2.8.8 firefox-68.12.0 
  yum -y install figlet-2.2.5

  #Install AGILE-GW-scripts
  #cd /opt/prod
  #git clone https://github.com/AGILESCIENCE/AGILE-GW-scripts.git
  #cd AGILE-GW-scripts
  #git checkout master

  PATH="/opt/anaconda3/bin:${PATH}"
  export PATH

  conda config --add channels conda-forge

  # Enabling python environment...
  #source activate py_alert_pipe_27
  #conda install -y networkx
  #pip install pyrr==0.9.2
  #source deactivate

  #environment for astropy region

  #conda create -y -n py_alert_pipe_27_bis python=2.7 numpy=1.12 matplotlib=2.0.2 astropy=2.0.3 scipy=0.18.1 pytest=3.8.0 mysql-connector-python=2.0.4
  # Enabling python environment...
  #source activate py_alert_pipe_27_bis
  #conda install -y networkx
  #pip install healpy==1.11.0
  #conda install -y -c astropy regions
  #pip install pyastronomy==0.12.0
  #pip install pyrr==0.9.2
  #source deactivate

  conda create -y -n ligo_map_36 python=3.6 lxml=4.1.1 mysql-connector-python=2.0.4
  source activate ligo_map_36
  conda install -y geojson=2.4.1 
  #conda install -y -c conda-forge ligo.skymap=0.3.1 # geojson=2.4.1
  #rm /opt/anaconda3/envs/ligo_map_36/lib/python3.6/site-packages/ligo/skymap/tool/ligo_skymap_plot.py
  #mvi/opt/conf/ligo_skymap_plot.py /opt/anaconda3/envs/ligo_map_36/lib/python3.6/site-packages/ligo/skymap/tool/ligo_skymap_plot.py
  source deactivate


  #conda create -y -n grid_circular python=3.6 networkx numpy matplotlib astropy scipy pytest=3.8.0 mysql-connector-python=2.0.4

  #source activate grid_circular
  #conda install -y -c conda-forge ligo.skymap geojson
  #rm -r /opt/anaconda3/envs/grid_circular/lib/python3.6/site-packages/ligo
  #mv /opt/conf/ligo /opt/anaconda3/envs/grid_circular/lib/python3.6/site-packages/
  #pip install pyastronomy==0.12.0
  #pip install healpy==1.11.0
  #pip install pyrr==0.9.2
  #source deactivate

  # Enabling python environment...
  source /etc/profile.d/conda.sh
  #for MCAL
  #source activate py_mcal_27
  #conda install -y configparser
  #conda install -y networkx
  #pip install pyastronomy==0.12.0
  #pip install pyrr==0.9.2
  #pip install pyfits==3.5
  #conda install -y -c conda-forge healpy=1.11.0
  #pip install healpy==1.11.0
  #source deactivate

  gem install mysql tlsmail

  #create environment for agilepy
  #conda config --add channels agilescience
  #conda create -y -n agile agilepy

  conda clean -a -y

  # Python for manual analysis
  #conda create -y -n py_manual_27 python=2.7.5 scipy=0.18.1 numpy=1.12 matplotlib=2.0.2 basemap=1.0.7 lxml=3.2.1 mysql-connector-python=2.0.4 astropy=2.0.3
  #source activate py_manual_27
  #pip install pyfits
  #source deactivate

  #cat /opt/conf/logo1 > /etc/motd

  rm -rf $SRC_DIR

  cd /opt/prod/GCNdaemon/gcn && make

cat << EOF > /etc/profile.d/custom_rta_bash.sh
          alias ls='ls --color'
          alias ll='ls --color -latr'
          alias la='ls --color -A'
          PS1="AFISSpipe [\u@\h \W]\$ "
          export PS1
EOF
  


%environment

  # export MODULELOAD="agile-B25-r5"
  # #export EXECCOM="llsubmit"
  # export EXECCOM="sbatch"
  # export PATH_DATA="/AGILE_PROC3/"
  export PATH_RES="/ANALYSIS3/"
  # export PATH_LOG="/ANALYSIS3/log/"
  # export ARCHIVE="ASDC2"
  # export AGILEPIPE="/opt/prod/AGILEPIPE/"
  # #spot6
  # export SPOT6CARDDIR="spot6"
  # export SPOT6QUEUE="large"
  # export SPOT6GEN_HTMLANDPNG=1
  SINGULARITY_SHELL="/bin/bash"
  cat /etc/motd

%runscript

%startscript

  # Check for initialization
  #if [ ! -d /var/lib/mysql/mysql ]; then
  #    echo "Initializing mysqld"
  #    mysqld --initialize  --init-file=$HOME/AGILE-containers/conf/init_db_script
      # remove init_db_script
  #fi

  #source /etc/profile.d/custom_rta_bash.sh

  # launch mysqld
  #echo "Start mysqld"
  #mysqld --secure-file-priv=NULL &
  #mysqld --port 60306 &
  #sleep 20

  #launch slurm
  #munged -f
  #slurmdbd
  #slurmctld
  #slurmd

  # launch apache
  #echo "Start apache"
  #/usr/sbin/httpd &
